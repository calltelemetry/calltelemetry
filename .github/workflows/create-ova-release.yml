name: Create OVA Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "OVA Release version (e.g., X.Y.Z-rcN)"
        required: true
        type: string
      traceroute_version:
        description: "Traceroute version override (leave empty for default: 0.8.5-rc27)"
        required: false
        type: string
      jtapi_version:
        description: "JTAPI sidecar version override (leave empty to use main version)"
        required: false
        type: string
      ct_media_version:
        description: "ct-media version override (leave empty for default: 0.2.5)"
        required: false
        type: string

jobs:
  create-ova-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_RELEASE_TOKEN }}

      - name: Resolve versions
        id: resolve
        run: |
          VERSION="${{ inputs.version }}"

          # Unified version for web and vue (always match main version)
          WEB_VERSION="$VERSION"
          VUE_VERSION="$VERSION"

          # Traceroute has its own release cadence
          TRACEROUTE_VERSION="${{ inputs.traceroute_version }}"
          if [ -z "$TRACEROUTE_VERSION" ]; then
            TRACEROUTE_VERSION="0.8.5-rc27"
          fi

          # JTAPI defaults to main version (unified release stamps all repos)
          JTAPI_VERSION="${{ inputs.jtapi_version }}"
          if [ -z "$JTAPI_VERSION" ]; then
            JTAPI_VERSION="$VERSION"
          fi

          # ct-media has its own version
          CT_MEDIA_VERSION="${{ inputs.ct_media_version }}"
          if [ -z "$CT_MEDIA_VERSION" ]; then
            CT_MEDIA_VERSION="0.2.5"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "web_version=$WEB_VERSION" >> "$GITHUB_OUTPUT"
          echo "vue_version=$VUE_VERSION" >> "$GITHUB_OUTPUT"
          echo "traceroute_version=$TRACEROUTE_VERSION" >> "$GITHUB_OUTPUT"
          echo "jtapi_version=$JTAPI_VERSION" >> "$GITHUB_OUTPUT"
          echo "ct_media_version=$CT_MEDIA_VERSION" >> "$GITHUB_OUTPUT"

          echo "Creating OVA release $VERSION with:"
          echo "  - Web/API: $WEB_VERSION"
          echo "  - Vue Frontend: $VUE_VERSION"
          echo "  - Traceroute: $TRACEROUTE_VERSION"
          echo "  - JTAPI Sidecar: $JTAPI_VERSION"
          echo "  - ct-media: $CT_MEDIA_VERSION"

      - name: Generate version .env file
        run: |
          VERSION="${{ steps.resolve.outputs.version }}"
          mkdir -p ova/versions

          cat > "ova/versions/${VERSION}.env" << EOF
          # CallTelemetry OVA Release — ${VERSION}
          # Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          # ─── Image Versions ───
          WEB_VERSION=${{ steps.resolve.outputs.web_version }}
          VUE_VERSION=${{ steps.resolve.outputs.vue_version }}
          TRACEROUTE_VERSION=${{ steps.resolve.outputs.traceroute_version }}
          JTAPI_VERSION=${{ steps.resolve.outputs.jtapi_version }}
          CT_MEDIA_VERSION=${{ steps.resolve.outputs.ct_media_version }}
          EOF

          # Strip leading whitespace from heredoc
          sed -i 's/^          //' "ova/versions/${VERSION}.env"

          echo "Generated ova/versions/${VERSION}.env:"
          cat "ova/versions/${VERSION}.env"

      - name: Generate legacy version YAML (backwards compat)
        run: |
          VERSION="${{ steps.resolve.outputs.version }}"
          WEB_VERSION="${{ steps.resolve.outputs.web_version }}"
          VUE_VERSION="${{ steps.resolve.outputs.vue_version }}"
          TRACEROUTE_VERSION="${{ steps.resolve.outputs.traceroute_version }}"

          # Generate legacy per-version compose file for older cli.sh that expect it
          cat > "ova/versions/${VERSION}.yaml" << 'COMPOSE_EOF'
          services:
            caddy:
              image: caddy:2-alpine
              ports:
                - "443:443"
              volumes:
                - ./Caddyfile:/etc/caddy/Caddyfile
                - ./certs:/certs:ro
              networks:
                - ct

            vue-web:
              image: "calltelemetry/vue:VUE_VERSION_PLACEHOLDER"
              restart: "always"
              expose:
                - "80"
              networks:
                - ct

            traceroute:
              image: "calltelemetry/traceroute:TRACEROUTE_VERSION_PLACEHOLDER"
              user: root
              expose:
                - "4100"
              networks:
                - ct

            db:
              image: "calltelemetry/postgres:14"
              user: root
              restart: "always"
              environment:
                - POSTGRES_USER=calltelemetry
                - POSTGRES_PASSWORD=postgres
                - POSTGRES_DB=calltelemetry_prod
              expose:
                - "5432"
              volumes:
                - ./postgres-data:/bitnami/postgresql
              networks:
                - ct

            web:
              image: "calltelemetry/web:WEB_VERSION_PLACEHOLDER"
              restart: "always"
              user: root
              expose:
                - 4000
                - 4080
              ports:
                - "80:4080"
                - "22:3022"
              environment:
                - DB_USER=calltelemetry
                - DB_PASSWORD=postgres
                - DB_HOSTNAME=db
                - DB_NAME=calltelemetry_prod
                - DB_PORT=5432
                - EXTERNAL_IP=$DEFAULT_IPV4
                - LOGGING_LEVEL=warning
                - ADMIN_NODE=TRUE
                - WORKER_NODE=TRUE
                - CERT_KEY=/home/app/cert/appliance_key.pem
                - CERT_PUBLIC=/home/app/cert/appliance.crt
                - HTTP_ADAPTER=HACKNEY
                - LOG_PATH=/var/log
              tmpfs:
                - /var/log:rw,mode=0555,size=5000m
              networks:
                - ct
              volumes:
                - ./certs:/home/app/cert:rw
              logging:
                driver: "json-file"
                options:
                  max-size: "100m"
                  max-file: "7"
                  compress: "true"

            nats:
              image: "nats:2.11"
              command: "-c /etc/nats/nats.conf"
              volumes:
                - ./nats.conf:/etc/nats/nats.conf
              expose:
                - "4222"
              networks:
                - ct

          networks:
            ct:

          volumes:
            certs:
              driver: local
            traefik-logs:
              driver: local
          COMPOSE_EOF

          # Strip leading whitespace and substitute version placeholders
          sed -i 's/^          //' "ova/versions/${VERSION}.yaml"
          sed -i "s|WEB_VERSION_PLACEHOLDER|${WEB_VERSION}|g" "ova/versions/${VERSION}.yaml"
          sed -i "s|VUE_VERSION_PLACEHOLDER|${VUE_VERSION}|g" "ova/versions/${VERSION}.yaml"
          sed -i "s|TRACEROUTE_VERSION_PLACEHOLDER|${TRACEROUTE_VERSION}|g" "ova/versions/${VERSION}.yaml"

          echo "Generated legacy ova/versions/${VERSION}.yaml"

      - name: Commit and create release
        run: |
          VERSION="${{ steps.resolve.outputs.version }}"

          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add version files
          git add "ova/versions/${VERSION}.env"
          git add "ova/versions/${VERSION}.yaml"
          git commit -m "feat: add OVA release $VERSION

          Version-pinned .env and compose configuration for OVA deployment."

          # Push the commit
          git push

          # Create GitHub release with both version files
          gh release create "$VERSION" \
            --title "CallTelemetry OVA $VERSION" \
            --notes "$(cat << NOTES_EOF
          ## CallTelemetry $VERSION

          | Image | Version |
          |-------|---------|
          | calltelemetry/web | ${{ steps.resolve.outputs.web_version }} |
          | calltelemetry/vue | ${{ steps.resolve.outputs.vue_version }} |
          | calltelemetry/traceroute | ${{ steps.resolve.outputs.traceroute_version }} |
          | calltelemetry/jtapi-sidecar | ${{ steps.resolve.outputs.jtapi_version }} |
          | calltelemetry/ct-media | ${{ steps.resolve.outputs.ct_media_version }} |

          ### Upgrade
          \`\`\`bash
          sudo ./cli.sh update $VERSION
          \`\`\`
          NOTES_EOF
          )" \
            "ova/versions/${VERSION}.env" \
            "ova/versions/${VERSION}.yaml"

          echo "Created release $VERSION"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

      - name: Summary
        run: |
          VERSION="${{ steps.resolve.outputs.version }}"
          echo "### OVA Release: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| calltelemetry/web | ${{ steps.resolve.outputs.web_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| calltelemetry/vue | ${{ steps.resolve.outputs.vue_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| calltelemetry/traceroute | ${{ steps.resolve.outputs.traceroute_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| calltelemetry/jtapi-sidecar | ${{ steps.resolve.outputs.jtapi_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| calltelemetry/ct-media | ${{ steps.resolve.outputs.ct_media_version }} |" >> $GITHUB_STEP_SUMMARY
